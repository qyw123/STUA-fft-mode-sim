# Makefile for GEMM_SA testbench

# Compiler
CXX = g++

# Directories - SystemC installation paths
SYSTEMC_HOME = /opt/systemc
INCLUDE_DIR = $(SYSTEMC_HOME)/include
LIB_DIR = $(SYSTEMC_HOME)/lib

# é¡¹ç›®è·¯å¾„é…ç½®
PROJECT_ROOT = ../../../../..
GEMM_SA_ROOT = ..
GEMM_INCLUDE_DIR = $(GEMM_SA_ROOT)/include
GEMM_SRC_DIR = $(GEMM_SA_ROOT)/src

# Compiler flags
DEBUG_FLAGS = -O0 -Wall -Wno-unused-variable -fsanitize=address,undefined -g
RELEASE_FLAGS = -O2 -DNDEBUG
CXXFLAGS = -std=c++17 -DSC_ALLOW_DEPRECATED_IEEE_API \
           -I. \
           -I$(INCLUDE_DIR) \
           -I$(GEMM_INCLUDE_DIR) \
           -I$(GEMM_SRC_DIR) \
           $(RELEASE_FLAGS)

# Linker flags
LDFLAGS = -L$(LIB_DIR) -Wl,-rpath=$(LIB_DIR)
LIBS = -lsystemc -lm

# Target executable
TARGET = gemm_pingpong_test

# Source files
MAIN_SRC = gemm_pingpong_test.cpp

# Implementation source files that need to be compiled
# Note: pipeline_simulation.cpp is included in GEMM_TLM.h, don't compile separately
IMPL_SOURCES = $(GEMM_SRC_DIR)/GEMM_TLM.cpp

# All source files
ALL_SOURCES = $(MAIN_SRC) $(IMPL_SOURCES)

# Header dependencies (for tracking changes)
HEADERS = matrix_test_utils.h \
          large_matrix_block_control.h \
          $(GEMM_INCLUDE_DIR)/GEMM_TLM.h \
          $(GEMM_INCLUDE_DIR)/PEA.h \
          $(GEMM_INCLUDE_DIR)/pe.h \
          $(GEMM_INCLUDE_DIR)/FIFO.h \
          $(GEMM_INCLUDE_DIR)/in_buf_vec.h \
          $(GEMM_INCLUDE_DIR)/out_buf_vec.h

# Template implementation files (included in headers, no separate compilation needed)
TEMPLATE_IMPL = $(GEMM_SRC_DIR)/PEA.cpp \
                $(GEMM_SRC_DIR)/pe.cpp \
                $(GEMM_SRC_DIR)/FIFO.cpp \
                $(GEMM_SRC_DIR)/in_buf_vec.cpp \
                $(GEMM_SRC_DIR)/out_buf_vec.cpp

# Build targets
all: $(TARGET)

# Debug build
debug: CXXFLAGS += $(DEBUG_FLAGS)
debug: CXXFLAGS := $(filter-out $(RELEASE_FLAGS),$(CXXFLAGS))
debug: $(TARGET)

# Main target
$(TARGET): $(ALL_SOURCES) $(HEADERS)
	@echo "ğŸš€ ç¼–è¯‘GEMMè„‰åŠ¨é˜µåˆ—æµ‹è¯•ç¨‹åº..."
	@echo "ç¼–è¯‘å™¨: $(CXX)"
	@echo "SystemC: $(SYSTEMC_HOME)"
	@echo "æºæ–‡ä»¶: $(ALL_SOURCES)"
	@echo "åŒ…å«è·¯å¾„: $(CXXFLAGS)"
	$(CXX) $(CXXFLAGS) $(LDFLAGS) -o $@ $(ALL_SOURCES) $(LIBS)
	@echo "âœ… ç¼–è¯‘å®Œæˆ: $(TARGET)"

# Clean up
clean:
	@echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘æ–‡ä»¶..."
	rm -f $(TARGET)
	rm -f core
	rm -f *.o
	@echo "âœ… æ¸…ç†å®Œæˆ"

# Run the test
run: $(TARGET)
	@echo "ğŸ¯ è¿è¡ŒGEMMæµ‹è¯•ç¨‹åº..."
	@echo "========================================="
	./$(TARGET)
	@echo "========================================="
	@echo "âœ… æµ‹è¯•è¿è¡Œå®Œæˆ"

# Quick test run with limited output
test: $(TARGET)
	@echo "âš¡ å¿«é€Ÿæµ‹è¯•è¿è¡Œ..."
	./$(TARGET)

# Verbose run with all debug output
verbose: $(TARGET)
	@echo "ğŸ“Š è¯¦ç»†æµ‹è¯•è¿è¡Œ..."
	./$(TARGET) 2>&1 | tee test_output.log
	@echo "ğŸ“ è¯¦ç»†è¾“å‡ºå·²ä¿å­˜åˆ° test_output.log"

# Check SystemC installation
check-systemc:
	@echo "ğŸ” æ£€æŸ¥SystemCå®‰è£…..."
	@if [ -d "$(SYSTEMC_HOME)" ]; then \
		echo "âœ… SystemCç›®å½•å­˜åœ¨: $(SYSTEMC_HOME)"; \
	else \
		echo "âŒ SystemCç›®å½•ä¸å­˜åœ¨: $(SYSTEMC_HOME)"; \
		exit 1; \
	fi
	@if [ -f "$(INCLUDE_DIR)/systemc.h" ]; then \
		echo "âœ… SystemCå¤´æ–‡ä»¶å­˜åœ¨"; \
	else \
		echo "âŒ SystemCå¤´æ–‡ä»¶ä¸å­˜åœ¨: $(INCLUDE_DIR)/systemc.h"; \
		exit 1; \
	fi
	@if [ -f "$(LIB_DIR)/libsystemc.so" ] || [ -f "$(LIB_DIR)/libsystemc.a" ]; then \
		echo "âœ… SystemCåº“æ–‡ä»¶å­˜åœ¨"; \
	else \
		echo "âŒ SystemCåº“æ–‡ä»¶ä¸å­˜åœ¨äº: $(LIB_DIR)"; \
		exit 1; \
	fi

# Show build info
info:
	@echo "ğŸ“‹ GEMM_SAæµ‹è¯•å¹³å°æ„å»ºä¿¡æ¯"
	@echo "================================"
	@echo "ç¼–è¯‘å™¨: $(CXX)"
	@echo "SystemC: $(SYSTEMC_HOME)"
	@echo "ç›®æ ‡æ–‡ä»¶: $(TARGET)"
	@echo "æºæ–‡ä»¶: $(MAIN_SRC)"
	@echo "ç¼–è¯‘æ ‡å¿—: $(CXXFLAGS)"
	@echo "é“¾æ¥æ ‡å¿—: $(LDFLAGS) $(LIBS)"
	@echo "================================"

# Install systemc (if needed)
install-systemc:
	@echo "âš ï¸  è¯·å‚è€ƒSystemCå®˜æ–¹å®‰è£…æŒ‡å—"
	@echo "   https://www.accellera.org/downloads/standards/systemc"

# Help
help:
	@echo "ğŸš€ GEMM_SAæµ‹è¯•å¹³å° Makefile"
	@echo "ä½¿ç”¨æ–¹æ³•:"
	@echo "  make            - ç¼–è¯‘ç¨‹åº"
	@echo "  make debug      - ç¼–è¯‘è°ƒè¯•ç‰ˆæœ¬"
	@echo "  make run        - ç¼–è¯‘å¹¶è¿è¡Œæµ‹è¯•"
	@echo "  make test       - å¿«é€Ÿæµ‹è¯•è¿è¡Œ"
	@echo "  make verbose    - è¯¦ç»†æµ‹è¯•è¿è¡Œ"
	@echo "  make clean      - æ¸…ç†ç¼–è¯‘æ–‡ä»¶"
	@echo "  make check-systemc - æ£€æŸ¥SystemCå®‰è£…"
	@echo "  make info       - æ˜¾ç¤ºæ„å»ºä¿¡æ¯"
	@echo "  make help       - æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯"

.PHONY: all debug clean run test verbose check-systemc info install-systemc help
